[tox]
# Test against Python 3.10, 3.11, 3.12, and 3.13
envlist = py{310,311,312,313}, type, lint, coverage
isolated_build = true
skip_missing_interpreters = true

[testenv]
# Install dependencies using uv for faster installation
deps =
    pytest>=7.0.0
    pytest-asyncio>=0.21.0
    pytest-mock>=3.11.0
    pytest-cov>=4.1.0
    pytest-xdist>=3.3.0
    pytest-timeout>=2.1.0
    pytest-benchmark>=4.0.0
    testcontainers>=3.7.0
    httpx>=0.24.0
    respx>=0.20.0
    scikit-learn>=1.0.0
    rank-bm25>=0.2.2
    nltk>=3.8.1
    hypothesis>=6.0.0

# Core test command - run unit and integration tests
# Exclude slow e2e tests for faster feedback
commands =
    pytest tests/unit tests/integration -v --tb=short -m "not slow" {posargs}

# Set environment variables
setenv =
    PYTHONPATH = {toxinidir}/src/python
    QDRANT_URL = http://localhost:6333

[testenv:py{310,311,312,313}-full]
# Full test suite including e2e tests
commands =
    pytest tests/ -v --tb=short {posargs}

[testenv:py{310,311,312,313}-compatibility]
# Compatibility-specific tests validating version-specific features
commands =
    pytest tests/compatibility -v --tb=short {posargs}

[testenv:type]
# Type checking with mypy across all Python versions
basepython = python3.10
deps =
    mypy>=1.0.0
    types-PyYAML>=6.0.0
    types-Markdown>=3.4.0
    types-psutil>=5.8.0
commands =
    mypy src/python/workspace_qdrant_mcp --python-version 3.10
    mypy src/python/workspace_qdrant_mcp --python-version 3.11
    mypy src/python/workspace_qdrant_mcp --python-version 3.12
    mypy src/python/workspace_qdrant_mcp --python-version 3.13

[testenv:lint]
# Linting with ruff and black
basepython = python3.10
deps =
    ruff>=0.1.0
    black>=23.0.0
commands =
    ruff check src/python tests
    black --check src/python tests

[testenv:coverage]
# Code coverage report
basepython = python3.10
deps =
    {[testenv]deps}
    pytest-cov>=4.1.0
commands =
    pytest tests/unit tests/integration \
        --cov=workspace_qdrant_mcp \
        --cov=common \
        --cov=wqm_cli \
        --cov-report=html \
        --cov-report=term-missing \
        --cov-fail-under=80 \
        -m "not slow"

[testenv:py{310,311,312,313}-deps]
# Dependency compatibility testing
# Tests installation and import of all dependencies
commands =
    python -c "import sys; print(f'Python {{sys.version}}')"
    python -c "import qdrant_client; print(f'qdrant-client {{qdrant_client.__version__}}')"
    python -c "import fastembed; print(f'fastembed {{fastembed.__version__}}')"
    python -c "import fastmcp; print('fastmcp OK')"
    python -c "import fastapi; print('fastapi OK')"
    python -c "import pydantic; print(f'pydantic {{pydantic.VERSION}}')"
    python -c "import GitPython; print('GitPython OK')"
    pytest tests/compatibility/test_dependency_versions.py -v

[testenv:benchmark]
# Performance benchmarking across Python versions
basepython = python3.{10,11,12,13}
deps =
    {[testenv]deps}
commands =
    pytest tests/ --benchmark-only --benchmark-autosave

[gh-actions]
# GitHub Actions integration - map Python versions to tox environments
python =
    3.10: py310, type, lint, coverage
    3.11: py311
    3.12: py312
    3.13: py313
