name: Rust CLI Build

on:
  push:
    branches: [main, develop, 'feature/**', 'release/**']
    paths:
      - 'src/rust/cli/**'
      - '.github/workflows/rust-cli-build.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/rust/cli/**'
      - '.github/workflows/rust-cli-build.yml'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_build:
        description: 'Build release artifacts'
        required: false
        default: 'false'
        type: boolean

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Quick checks (format, lint)
  check:
    name: Check & Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Install protobuf compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            src/rust/cli/target/
          key: ${{ runner.os }}-cargo-cli-${{ hashFiles('src/rust/cli/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-cli-

      - name: Check formatting
        run: cargo fmt --all --check
        working-directory: src/rust/cli

      - name: Clippy lints
        run: cargo clippy --workspace -- -D warnings
        working-directory: src/rust/cli

  # Build and test on multiple platforms
  build:
    name: Build (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    needs: check
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS
          - target: x86_64-apple-darwin
            os: macos-13  # Intel runner
            artifact_name: wqm-macos-intel
          - target: aarch64-apple-darwin
            os: macos-14  # ARM64 runner
            artifact_name: wqm-macos-arm64

          # Linux
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            artifact_name: wqm-linux-x64

          # Windows
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            artifact_name: wqm-windows-x64

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            src/rust/cli/target/
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-cli-${{ hashFiles('src/rust/cli/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-cargo-cli-
            ${{ runner.os }}-cargo-cli-

      # Platform-specific dependencies
      - name: Install Linux dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - name: Install macOS dependencies
        if: runner.os == 'macOS'
        run: |
          brew install protobuf

      - name: Install Windows dependencies
        if: runner.os == 'Windows'
        run: |
          choco install protoc
        shell: pwsh

      # Build release binary
      - name: Build release binary
        run: cargo build --release --target ${{ matrix.target }}
        working-directory: src/rust/cli

      # Run tests (only on native runners)
      - name: Run tests
        run: cargo test --release --target ${{ matrix.target }}
        working-directory: src/rust/cli

      # Verify binary works
      - name: Test binary (Unix)
        if: runner.os != 'Windows'
        run: |
          ./target/${{ matrix.target }}/release/wqm --version
          ./target/${{ matrix.target }}/release/wqm --help
        working-directory: src/rust/cli

      - name: Test binary (Windows)
        if: runner.os == 'Windows'
        run: |
          .\target\${{ matrix.target }}\release\wqm.exe --version
          .\target\${{ matrix.target }}\release\wqm.exe --help
        working-directory: src/rust/cli
        shell: pwsh

      # Strip binary for smaller size (Unix only)
      - name: Strip binary (Unix)
        if: runner.os != 'Windows'
        run: |
          strip target/${{ matrix.target }}/release/wqm
          ls -lh target/${{ matrix.target }}/release/wqm
        working-directory: src/rust/cli

      # Upload artifacts
      - name: Upload binary (Unix)
        if: runner.os != 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: src/rust/cli/target/${{ matrix.target }}/release/wqm
          retention-days: 14

      - name: Upload binary (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: src/rust/cli/target/${{ matrix.target }}/release/wqm.exe
          retention-days: 14

  # Performance benchmark
  benchmark:
    name: Startup Performance
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Linux binary
        uses: actions/download-artifact@v4
        with:
          name: wqm-linux-x64
          path: ./bin

      - name: Make binary executable
        run: chmod +x ./bin/wqm

      - name: Install hyperfine
        run: |
          wget https://github.com/sharkdp/hyperfine/releases/download/v1.18.0/hyperfine_1.18.0_amd64.deb
          sudo dpkg -i hyperfine_1.18.0_amd64.deb

      - name: Run startup benchmark
        run: |
          echo "## CLI Startup Performance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          hyperfine --warmup 3 --runs 10 './bin/wqm --version' 2>&1 | tee -a $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Verify performance target
        run: |
          # Get mean time in milliseconds
          MEAN_TIME=$(hyperfine --export-json results.json './bin/wqm --version' && jq '.results[0].mean * 1000' results.json)
          echo "Mean startup time: ${MEAN_TIME}ms"

          # Check if under 100ms target
          if (( $(echo "$MEAN_TIME < 100" | bc -l) )); then
            echo "✅ Performance target met (<100ms)" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Performance target exceeded (>100ms)" >> $GITHUB_STEP_SUMMARY
          fi

  # Release job (only on published releases or manual trigger)
  release:
    name: Create Release Artifacts
    runs-on: ubuntu-latest
    needs: [build, benchmark]
    if: github.event_name == 'release' || github.event.inputs.release_build == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Prepare release archives
        run: |
          mkdir -p release

          # macOS Intel
          cd artifacts/wqm-macos-intel
          chmod +x wqm
          tar -czvf ../../release/wqm-macos-intel.tar.gz wqm
          cd ../..

          # macOS ARM64
          cd artifacts/wqm-macos-arm64
          chmod +x wqm
          tar -czvf ../../release/wqm-macos-arm64.tar.gz wqm
          cd ../..

          # Linux x64
          cd artifacts/wqm-linux-x64
          chmod +x wqm
          tar -czvf ../../release/wqm-linux-x64.tar.gz wqm
          cd ../..

          # Windows x64
          cd artifacts/wqm-windows-x64
          zip ../../release/wqm-windows-x64.zip wqm.exe
          cd ../..

          # Generate checksums
          cd release
          sha256sum * > checksums.txt
          cat checksums.txt

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: release/
          retention-days: 30

      - name: Upload to GitHub Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/wqm-macos-intel.tar.gz
            release/wqm-macos-arm64.tar.gz
            release/wqm-linux-x64.tar.gz
            release/wqm-windows-x64.zip
            release/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Summary job
  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [check, build, benchmark]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "# Rust CLI Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Status" >> $GITHUB_STEP_SUMMARY
          echo "- Check & Lint: ${{ needs.check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Benchmark: ${{ needs.benchmark.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Targets" >> $GITHUB_STEP_SUMMARY
          echo "- macOS Intel (x86_64-apple-darwin)" >> $GITHUB_STEP_SUMMARY
          echo "- macOS ARM64 (aarch64-apple-darwin)" >> $GITHUB_STEP_SUMMARY
          echo "- Linux x64 (x86_64-unknown-linux-gnu)" >> $GITHUB_STEP_SUMMARY
          echo "- Windows x64 (x86_64-pc-windows-msvc)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Performance Target" >> $GITHUB_STEP_SUMMARY
          echo "- Startup time target: <100ms" >> $GITHUB_STEP_SUMMARY
