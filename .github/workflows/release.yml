# Cross-platform release build workflow for workspace-qdrant-mcp
# Builds memexd daemon and wqm CLI for 6 target platforms
#
# ONNX Runtime Static Linking:
# - Most platforms: ort crate automatically downloads prebuilt static binaries
# - Intel Mac (x86_64-apple-darwin): ort crate dropped support in v2.0.0-rc.11,
#   so we download Microsoft's ONNX Runtime and set ORT_LIB_LOCATION
#
# All binaries are self-contained with ONNX Runtime statically linked.
# See: WORKSPACE_QDRANT_MCP.md section "ONNX Runtime Static Linking"
#
# Targets:
# - ARM Mac (aarch64-apple-darwin)
# - Intel Mac (x86_64-apple-darwin) - requires manual ONNX Runtime
# - ARM Windows (aarch64-pc-windows-msvc)
# - Intel Windows (x86_64-pc-windows-msvc)
# - Linux x86_64 (x86_64-unknown-linux-gnu)
# - Linux ARM (aarch64-unknown-linux-gnu)

name: Release Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v0.3.0)'
        required: false
        default: 'test'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  # ONNX Runtime version for Intel Mac (only platform that needs manual download)
  ORT_VERSION: "1.23.2"

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS ARM (Apple Silicon) - ort has prebuilt binaries
          - target: aarch64-apple-darwin
            os: macos-latest
            cross: false
            artifact_name: darwin-arm64
            needs_ort_download: false

          # macOS Intel - ort dropped support, needs manual ONNX Runtime
          - target: x86_64-apple-darwin
            os: macos-13  # Intel runner
            cross: false
            artifact_name: darwin-x64
            needs_ort_download: true

          # Windows x64 - ort has prebuilt binaries
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            cross: false
            artifact_name: windows-x64
            needs_ort_download: false

          # Windows ARM64 - ort has prebuilt binaries
          - target: aarch64-pc-windows-msvc
            os: windows-latest
            cross: false  # Native ARM support on Windows runner
            artifact_name: windows-arm64
            needs_ort_download: false

          # Linux x64 - ort has prebuilt binaries
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            cross: false
            artifact_name: linux-x64
            needs_ort_download: false

          # Linux ARM64 - ort has prebuilt binaries
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            cross: true  # Use cross for ARM compilation
            artifact_name: linux-arm64
            needs_ort_download: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross (Linux ARM64)
        if: matrix.cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      # macOS specific: Install dependencies
      - name: Install macOS dependencies
        if: runner.os == 'macOS'
        run: |
          brew install cmake protobuf

      # Linux specific: Install dependencies
      - name: Install Linux dependencies
        if: runner.os == 'Linux' && !matrix.cross
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler libprotobuf-dev cmake

      # Windows specific: Install dependencies
      - name: Install Windows dependencies
        if: runner.os == 'Windows'
        run: |
          choco install protoc cmake -y

      # Cache Rust dependencies
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src/rust/target
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-cargo-

      # Download ONNX Runtime static library for Intel Mac (ort crate handles other platforms)
      # Uses supertone-inc/onnxruntime-build which provides static libraries (.a)
      - name: Cache ONNX Runtime (Intel Mac)
        if: matrix.needs_ort_download
        uses: actions/cache@v4
        id: onnx-cache
        with:
          path: ~/.onnxruntime-static
          key: onnxruntime-static-${{ env.ORT_VERSION }}-${{ matrix.target }}

      - name: Download ONNX Runtime static library (Intel Mac)
        if: matrix.needs_ort_download && steps.onnx-cache.outputs.cache-hit != 'true'
        shell: bash
        run: |
          mkdir -p ~/.onnxruntime-static
          echo "Downloading ONNX Runtime ${{ env.ORT_VERSION }} static library for Intel Mac..."
          # Download from supertone-inc/onnxruntime-build (provides static libraries)
          curl -L "https://github.com/supertone-inc/onnxruntime-build/releases/download/v${{ env.ORT_VERSION }}/onnxruntime-osx-universal2-static_lib-${{ env.ORT_VERSION }}.tgz" -o ~/.onnxruntime-static/ort.tgz
          tar xzf ~/.onnxruntime-static/ort.tgz -C ~/.onnxruntime-static
          rm ~/.onnxruntime-static/ort.tgz
          echo "ONNX Runtime static library downloaded to ~/.onnxruntime-static"
          ls -la ~/.onnxruntime-static/lib/

      # Set ORT environment for Intel Mac static linking
      - name: Set ORT environment (Intel Mac)
        if: matrix.needs_ort_download
        shell: bash
        run: |
          # Intel Mac: Use static library for truly self-contained binary
          # Point to lib subdirectory where libonnxruntime.a is located
          echo "ORT_LIB_LOCATION=$HOME/.onnxruntime-static/lib" >> $GITHUB_ENV
          echo "Set ORT_LIB_LOCATION=$HOME/.onnxruntime-static/lib for static linking"

      # Build binaries
      - name: Build (native)
        if: "!matrix.cross"
        working-directory: src/rust
        run: cargo build --release --target ${{ matrix.target }}

      - name: Build (cross)
        if: matrix.cross
        working-directory: src/rust
        run: cross build --release --target ${{ matrix.target }}

      # Prepare artifacts - all binaries are self-contained with ONNX Runtime statically linked
      - name: Prepare artifacts (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          mkdir -p artifacts
          cp src/rust/target/${{ matrix.target }}/release/memexd artifacts/
          cp src/rust/target/${{ matrix.target }}/release/wqm artifacts/
          cp THIRD-PARTY-LICENSES.md artifacts/
          cp LICENSE artifacts/

          # Create archive
          cd artifacts
          tar -czvf ../workspace-qdrant-mcp-${{ matrix.artifact_name }}.tar.gz *

      - name: Prepare artifacts (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path artifacts
          Copy-Item src/rust/target/${{ matrix.target }}/release/memexd.exe artifacts/
          Copy-Item src/rust/target/${{ matrix.target }}/release/wqm.exe artifacts/
          Copy-Item THIRD-PARTY-LICENSES.md artifacts/
          Copy-Item LICENSE artifacts/

          Compress-Archive -Path artifacts/* -DestinationPath workspace-qdrant-mcp-${{ matrix.artifact_name }}.zip

      # Verify binaries are self-contained (no unexpected dynamic dependencies)
      - name: Verify binary dependencies (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: scripts/verify-deps-macos.sh artifacts/memexd artifacts/wqm

      - name: Verify binary dependencies (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: scripts/verify-deps-linux.sh artifacts/memexd artifacts/wqm

      - name: Verify binary dependencies (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: scripts/verify-deps-windows.ps1 artifacts/memexd.exe artifacts/wqm.exe

      # Smoke tests - verify binaries are runnable
      - name: Smoke test (Unix)
        if: runner.os != 'Windows' && !matrix.cross
        shell: bash
        run: |
          echo "Running smoke tests..."
          artifacts/memexd --version
          artifacts/wqm --version
          echo "Smoke tests passed"

      - name: Smoke test (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "Running smoke tests..."
          & artifacts/memexd.exe --version
          & artifacts/wqm.exe --version
          Write-Host "Smoke tests passed"

      # Create individual binary files for direct download (used by wqm update)
      - name: Prepare individual binaries (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          # Copy daemon binary with target-specific name
          cp artifacts/memexd memexd-${{ matrix.target }}

          # Generate checksum for individual binary
          sha256sum memexd-${{ matrix.target }} | awk '{print $1}' > memexd-${{ matrix.target }}.sha256

          # Also prepare CLI binary
          cp artifacts/wqm wqm-${{ matrix.target }}
          sha256sum wqm-${{ matrix.target }} | awk '{print $1}' > wqm-${{ matrix.target }}.sha256

      - name: Prepare individual binaries (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # Copy daemon binary with target-specific name
          Copy-Item artifacts/memexd.exe memexd-${{ matrix.target }}.exe

          # Generate checksum for individual binary
          $hash = (Get-FileHash -Algorithm SHA256 memexd-${{ matrix.target }}.exe).Hash.ToLower()
          $hash | Out-File -NoNewline memexd-${{ matrix.target }}.exe.sha256

          # Also prepare CLI binary
          Copy-Item artifacts/wqm.exe wqm-${{ matrix.target }}.exe
          $hash = (Get-FileHash -Algorithm SHA256 wqm-${{ matrix.target }}.exe).Hash.ToLower()
          $hash | Out-File -NoNewline wqm-${{ matrix.target }}.exe.sha256

      # Upload artifacts
      - name: Upload artifact (Unix)
        if: runner.os != 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: workspace-qdrant-mcp-${{ matrix.artifact_name }}
          path: |
            workspace-qdrant-mcp-${{ matrix.artifact_name }}.tar.gz
            memexd-${{ matrix.target }}
            memexd-${{ matrix.target }}.sha256
            wqm-${{ matrix.target }}
            wqm-${{ matrix.target }}.sha256

      - name: Upload artifact (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: workspace-qdrant-mcp-${{ matrix.artifact_name }}
          path: |
            workspace-qdrant-mcp-${{ matrix.artifact_name }}.zip
            memexd-${{ matrix.target }}.exe
            memexd-${{ matrix.target }}.exe.sha256
            wqm-${{ matrix.target }}.exe
            wqm-${{ matrix.target }}.exe.sha256

  # Create release with all artifacts
  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate checksums
        run: |
          cd artifacts
          # Checksum for archives
          find . -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec sha256sum {} \; > checksums.txt
          cat checksums.txt

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/**/*.tar.gz
            artifacts/**/*.zip
            artifacts/**/memexd-*
            artifacts/**/wqm-*
            artifacts/checksums.txt
          draft: false
          prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}
          generate_release_notes: true
          body: |
            ## Self-Contained Binaries

            All binaries include ONNX Runtime statically linked - no external dependencies required.

            Each archive includes `LICENSE` and `THIRD-PARTY-LICENSES.md` with full attribution for all third-party dependencies.

            ### Quick Install
            ```bash
            # Linux/macOS
            curl -fsSL https://raw.githubusercontent.com/ChrisGVE/workspace-qdrant-mcp/main/scripts/download-install.sh | bash

            # Windows (PowerShell)
            irm https://raw.githubusercontent.com/ChrisGVE/workspace-qdrant-mcp/main/scripts/download-install.ps1 | iex
            ```

            ### Manual Download
            Choose the appropriate archive for your platform:
            - `darwin-arm64` - macOS Apple Silicon (M1/M2/M3)
            - `darwin-x64` - macOS Intel
            - `linux-x64` - Linux x86_64
            - `linux-arm64` - Linux ARM64
            - `windows-x64` - Windows x86_64
            - `windows-arm64` - Windows ARM64
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
