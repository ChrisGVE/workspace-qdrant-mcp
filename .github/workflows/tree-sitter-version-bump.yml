# Tree-sitter Version Bump Workflow
# Monitors tree-sitter releases and automatically creates PRs for version updates
name: Tree-sitter Version Bump

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      force_check:
        description: 'Force version check even if no new version'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  check-version:
    name: Check Tree-sitter Version
    runs-on: ubuntu-latest
    outputs:
      needs_update: ${{ steps.compare.outputs.needs_update }}
      current_version: ${{ steps.compare.outputs.current_version }}
      latest_version: ${{ steps.compare.outputs.latest_version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get current tree-sitter version from Cargo.toml
        id: current
        run: |
          # Extract tree-sitter version from daemon Cargo.toml
          CURRENT=$(grep 'tree-sitter = ' src/rust/daemon/core/Cargo.toml | head -1 | sed 's/.*"\([^"]*\)".*/\1/')
          echo "version=$CURRENT" >> $GITHUB_OUTPUT
          echo "Current tree-sitter version: $CURRENT"

      - name: Get latest tree-sitter version from crates.io
        id: latest
        run: |
          # Query crates.io API for latest tree-sitter version
          LATEST=$(curl -sS 'https://crates.io/api/v1/crates/tree-sitter' | jq -r '.crate.max_stable_version // .crate.max_version')
          echo "version=$LATEST" >> $GITHUB_OUTPUT
          echo "Latest tree-sitter version: $LATEST"

      - name: Compare versions
        id: compare
        run: |
          CURRENT="${{ steps.current.outputs.version }}"
          LATEST="${{ steps.latest.outputs.version }}"

          echo "current_version=$CURRENT" >> $GITHUB_OUTPUT
          echo "latest_version=$LATEST" >> $GITHUB_OUTPUT

          if [ "$CURRENT" != "$LATEST" ]; then
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "Version update needed: $CURRENT -> $LATEST"
          else
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "Already at latest version: $CURRENT"
          fi

  create-update-pr:
    name: Create Update PR
    needs: check-version
    if: needs.check-version.outputs.needs_update == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create update branch
        env:
          LATEST_VERSION: ${{ needs.check-version.outputs.latest_version }}
        run: |
          BRANCH_NAME="deps/tree-sitter-${LATEST_VERSION}"
          git checkout -b "$BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Update tree-sitter version in Cargo.toml files
        env:
          CURRENT_VERSION: ${{ needs.check-version.outputs.current_version }}
          LATEST_VERSION: ${{ needs.check-version.outputs.latest_version }}
        run: |
          # Update all Cargo.toml files that reference tree-sitter
          find . -name 'Cargo.toml' -type f | while read file; do
            if grep -q 'tree-sitter' "$file"; then
              echo "Updating $file"
              sed -i "s/tree-sitter = \"$CURRENT_VERSION\"/tree-sitter = \"$LATEST_VERSION\"/g" "$file"
              sed -i "s/tree-sitter = { version = \"$CURRENT_VERSION\"/tree-sitter = { version = \"$LATEST_VERSION\"/g" "$file"
            fi
          done

          # Update tree-sitter grammar crate versions if needed
          # This updates tree-sitter-* crates to compatible versions
          cd src/rust/daemon
          cargo update tree-sitter || true
          cargo update -p tree-sitter || true

      - name: Update Cargo.lock
        working-directory: src/rust/daemon
        run: cargo update

      - name: Build and test
        id: build
        working-directory: src/rust/daemon
        continue-on-error: true
        run: |
          cargo build --release 2>&1 | tee build.log
          BUILD_STATUS=$?

          if [ $BUILD_STATUS -eq 0 ]; then
            echo "build_success=true" >> $GITHUB_OUTPUT
            echo "Build succeeded"

            # Run tests
            cargo test 2>&1 | tee test.log
            TEST_STATUS=$?

            if [ $TEST_STATUS -eq 0 ]; then
              echo "test_success=true" >> $GITHUB_OUTPUT
              echo "Tests passed"
            else
              echo "test_success=false" >> $GITHUB_OUTPUT
              echo "Tests failed"
            fi
          else
            echo "build_success=false" >> $GITHUB_OUTPUT
            echo "test_success=false" >> $GITHUB_OUTPUT
            echo "Build failed"
          fi

      - name: Commit changes
        if: steps.build.outputs.build_success == 'true'
        env:
          LATEST_VERSION: ${{ needs.check-version.outputs.latest_version }}
        run: |
          git add -A
          git commit -m "deps: bump tree-sitter to $LATEST_VERSION"

      - name: Push branch
        if: steps.build.outputs.build_success == 'true'
        run: git push origin "$branch_name"

      - name: Create Pull Request
        if: steps.build.outputs.build_success == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CURRENT_VERSION: ${{ needs.check-version.outputs.current_version }}
          LATEST_VERSION: ${{ needs.check-version.outputs.latest_version }}
          TEST_SUCCESS: ${{ steps.build.outputs.test_success }}
        run: |
          # Determine PR label based on test results
          if [ "$TEST_SUCCESS" == "true" ]; then
            LABELS="dependencies,automated,auto-merge"
            BODY_SUFFIX="All tests passed. This PR is eligible for auto-merge."
          else
            LABELS="dependencies,automated,needs-review"
            BODY_SUFFIX="**Note:** Some tests failed. Please review before merging."
          fi

          gh pr create \
            --title "deps: bump tree-sitter from $CURRENT_VERSION to $LATEST_VERSION" \
            --body "## Tree-sitter Version Update

Automated PR to update tree-sitter dependency.

### Changes
- Updated \`tree-sitter\` from \`$CURRENT_VERSION\` to \`$LATEST_VERSION\`
- Updated related tree-sitter grammar crates to compatible versions

### Changelog
See [tree-sitter releases](https://github.com/tree-sitter/tree-sitter/releases/tag/v$LATEST_VERSION) for details.

### Build Status
- Build: :white_check_mark: Passed
- Tests: $([ \"$TEST_SUCCESS\" == \"true\" ] && echo ':white_check_mark: Passed' || echo ':warning: Some failures')

$BODY_SUFFIX

---
*This PR was automatically created by the tree-sitter version bump workflow.*" \
            --label "$LABELS" \
            --base main \
            --head "$branch_name"

      - name: Enable auto-merge
        if: steps.build.outputs.build_success == 'true' && steps.build.outputs.test_success == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=$(gh pr view --json number -q '.number')
          gh pr merge "$PR_NUMBER" --auto --squash

      - name: Create issue on build failure
        if: steps.build.outputs.build_success == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CURRENT_VERSION: ${{ needs.check-version.outputs.current_version }}
          LATEST_VERSION: ${{ needs.check-version.outputs.latest_version }}
        run: |
          gh issue create \
            --title "Tree-sitter update to $LATEST_VERSION failed to build" \
            --body "## Tree-sitter Update Build Failure

The automated tree-sitter version bump workflow detected a new version but failed to build.

### Version Details
- Current: \`$CURRENT_VERSION\`
- Target: \`$LATEST_VERSION\`

### Build Log
\`\`\`
$(tail -100 src/rust/daemon/build.log 2>/dev/null || echo 'Build log not available')
\`\`\`

### Next Steps
1. Review the build failure
2. Check if breaking changes require code updates
3. Manually create a PR with the necessary fixes

---
*This issue was automatically created by the tree-sitter version bump workflow.*" \
            --label "bug,dependencies,automated"
  # Post-merge patch release is handled by deps-post-merge-release.yml
  # which triggers on push to main from dependency update branches.
